# Docker Compose for local development with live code mounting and logging
# This uses your local code directly without rebuilding the Docker image
version: '3.8'

services:
  slack-mcp-local:
    image: golang:1.24
    container_name: slack-mcp-local
    working_dir: /app
    command: go run cmd/slack-mcp-server/main.go mcp-server --transport stdio
    volumes:
      # Mount source code directories (read-only)
      - ./cmd:/app/cmd:ro
      - ./pkg:/app/pkg:ro
      - ./go.mod:/app/go.mod:ro
      - ./go.sum:/app/go.sum:ro
      # Mount templates file (read-only)
      - ./SLACK_TEMPLATES.md:/app/SLACK_TEMPLATES.md:ro
      # Mount cache directory (read-write for cache files)
      - ./cache:/app/cache
      # Mount downloads directory (read-write for downloaded files)
      - ./downloads:/app/downloads
      # Mount go mod cache for faster builds
      - go-mod-cache:/go/pkg/mod
    environment:
      # Pass through Slack tokens from host environment
      SLACK_MCP_XOXC_TOKEN: ${SLACK_MCP_XOXC_TOKEN}
      SLACK_MCP_XOXD_TOKEN: ${SLACK_MCP_XOXD_TOKEN}
      SLACK_MCP_XOXP_TOKEN: ${SLACK_MCP_XOXP_TOKEN}
      # MCP server configuration - passed from host
      SLACK_MCP_CUSTOM_TLS: ${SLACK_MCP_CUSTOM_TLS}
      SLACK_MCP_USER_AGENT: ${SLACK_MCP_USER_AGENT}
      # Optional features
      SLACK_MCP_ADD_MESSAGE_TOOL: ${SLACK_MCP_ADD_MESSAGE_TOOL:-}
      SLACK_MCP_ADD_REACTION_TOOL: ${SLACK_MCP_ADD_REACTION_TOOL:-}
      SLACK_MCP_DELETE_MESSAGE_TOOL: ${SLACK_MCP_DELETE_MESSAGE_TOOL:-}
      SLACK_MCP_UPDATE_MESSAGE_TOOL: ${SLACK_MCP_UPDATE_MESSAGE_TOOL:-}
      # Bot token for posting as bot identity
      SLACK_MCP_BOT_TOKEN: ${SLACK_MCP_BOT_TOKEN:-}
      # Logging
      SLACK_MCP_LOG_LEVEL: ${SLACK_MCP_LOG_LEVEL:-debug}
      # Downloads directory (maps to ./downloads on host)
      SLACK_MCP_DOWNLOAD_DIR: /app/downloads
      # Host path for downloads (used to translate container paths to host paths)
      # Set this to your absolute host downloads path (e.g., /Users/yourname/slack-mcp-server/downloads)
      SLACK_MCP_HOST_DOWNLOADS_PATH: ${SLACK_MCP_HOST_DOWNLOADS_PATH:-}
      # Go environment
      CGO_ENABLED: "0"
      GOTOOLCHAIN: "local"
      GOCACHE: "/go/pkg/mod"
    stdin_open: true
    tty: true
    # Ensure clean shutdown
    stop_signal: SIGTERM
    stop_grace_period: 10s
    # Restart policy for development
    restart: "no"
    # Resource limits (optional, adjust as needed)
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '2'
        reservations:
          memory: 256M
          cpus: '0.5'

volumes:
  go-mod-cache:
    name: slack-mcp-go-mod-cache